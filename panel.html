<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Administrativo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:'Segoe UI',Arial;
  background:#f4f7fb;
  margin:0;
}

.container{
  padding:40px;
  max-width:1300px;
  margin:auto;
}

.card{
  background:#fff;
  border-radius:18px;
  padding:30px;
  box-shadow:0 15px 35px rgba(0,0,0,.08);
}

/* CONTROLES */
.controls{
  display:flex;
  gap:10px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.controls input{
  padding:10px;
  border-radius:8px;
  border:1px solid #ddd;
  min-width:240px;
}

button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
}

.btn-load{ background:#3b82f6; color:#fff; }
.btn-success{ background:#10b981; color:#fff; }
.btn-secondary{ background:#0ea5e9; color:#fff; }
.btn-edit{ background:#6366f1; color:#fff; padding:6px 12px; }
.btn-danger{ background:#ef4444; color:#fff; padding:6px 12px; }

/* TABLA */
table{ width:100%; border-collapse:collapse; }
th{ background:#f1f5f9; padding:14px; }
td{
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:center;
  font-size:13px;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:flex-start;
  justify-content:center;
  padding:12px;
  z-index:1000;
}

.modal-content{
  background:#fff;
  width:520px;
  max-width:100%;
  max-height:90vh;
  overflow-y:auto;
  padding:20px;
  border-radius:16px;
}

input,select{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:8px;
  border:1px solid #ddd;
}

.footer-btns{
  margin-top:16px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.footer-btns button{
  flex:1;
}

/* MOBILE */
@media(max-width:768px){
  .controls{ flex-direction:column; }
  .controls input{ min-width:0;width:100%; }
  table, thead{ display:none; }
}
</style>
</head>

<body>

<div class="container">
<div class="card">

<!-- CONTROLES -->
<div class="controls">
  <button class="btn-load" onclick="cargarUsuarios()">Cargar usuarios</button>
  <input id="busqueda" placeholder="Buscar usuario / rol" oninput="filtrarUsuarios()">
  <button class="btn-success" onclick="abrirCrearUsuario()">+ Usuario</button>
  <button class="btn-secondary" onclick="abrirModulos()">‚öôÔ∏è M√≥dulos</button>
</div>

<!-- USUARIOS -->
<table>
<thead>
<tr>
  <th>Usuario</th>
  <th>Contrase√±a</th>
  <th>Nombre</th>
  <th>Rol</th>
  <th>Activo</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody id="tablaUsuarios">
<tr><td colspan="6">Presione ‚ÄúCargar usuarios‚Äù</td></tr>
</tbody>
</table>

</div>
</div>

<!-- MODAL USUARIO -->
<div class="modal" id="modalUsuario">
<div class="modal-content">
<h3 id="tituloUsuario"></h3>

<input id="u_user" placeholder="Usuario">
<input id="u_pass" placeholder="Contrase√±a">
<input id="u_nombre" placeholder="Nombre">

<select id="u_rol">
  <option>ADMIN</option>
  <option>OPERADOR</option>
  <option>SUPERVISOR</option>
</select>

<select id="u_activo">
  <option value="SI">ACTIVO</option>
  <option value="NO">INACTIVO</option>
</select>

<h4>Permisos</h4>
<div id="listaPermisos"></div>

<div class="footer-btns">
  <button class="btn-success" onclick="guardarUsuario()">Guardar</button>
  <button class="btn-danger" onclick="cerrarUsuario()">Cancelar</button>
</div>
</div>
</div>

<!-- MODAL MODULOS -->
<div class="modal" id="modalModulos">
<div class="modal-content">
<h3>Administrar M√≥dulos</h3>

<input id="m_nombre" placeholder="Nombre del m√≥dulo">
<input id="m_archivo" placeholder="Archivo HTML (ej: index2.html)">
<input id="m_icono" placeholder="Icono (üì¶)">
<input id="m_permiso" placeholder="Permiso (ej: inventario)">

<select id="m_activo">
  <option value="SI">ACTIVO</option>
  <option value="NO">INACTIVO</option>
</select>

<div class="footer-btns">
  <button class="btn-success" onclick="crearModulo()">Guardar m√≥dulo</button>
  <button class="btn-danger" onclick="cerrarModulos()">Cerrar</button>
</div>

<hr>
<h4>M√≥dulos existentes</h4>
<div id="listaModulos"></div>

</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzhpjRngwZW2z4d49pUuHtEci23KFxZkETu-SvB5OPPDJpXnqOkc_MchNE-nWYPfAzw/exec";
let usuarios=[];

/* ========== USUARIOS ========== */
async function cargarUsuarios(){
 const r=await fetch(API+"?action=listarUsuarios");
 const d=await r.json();
 usuarios=d.data||[];
 renderUsuarios(usuarios);
}

function renderUsuarios(data){
 tablaUsuarios.innerHTML="";
 data.forEach(u=>{
  tablaUsuarios.innerHTML+=`
  <tr>
    <td>${u[1]}</td>
    <td>${u[2]}</td>
    <td>${u[3]}</td>
    <td>${u[4]}</td>
    <td>${u[5]}</td>
    <td>
      <button class="btn-edit" onclick="editarUsuario('${u[1]}','${u[2]}','${u[3]}','${u[4]}','${u[5]}','${u[10]||""}')">Editar</button>
      <button class="btn-danger" onclick="eliminarUsuario('${u[1]}')">Eliminar</button>
    </td>
  </tr>`;
 });
}

function filtrarUsuarios(){
 const q=busqueda.value.toLowerCase();
 renderUsuarios(usuarios.filter(u=>
  u[1].toLowerCase().includes(q) ||
  u[3].toLowerCase().includes(q) ||
  u[4].toLowerCase().includes(q)
 ));
}

/* ========== MODULOS ========== */
function abrirModulos(){
 modalModulos.style.display="flex";
 cargarModulos();
}

function cerrarModulos(){
 modalModulos.style.display="none";
}

async function cargarModulos(){
 const r=await fetch(API+"?action=listarModulos");
 const d=await r.json();
 listaModulos.innerHTML="";
 listaPermisos.innerHTML="";
 (d.data||[]).forEach(m=>{
  listaModulos.innerHTML+=`<div>‚Ä¢ ${m[3]} ${m[1]} (${m[5]})</div>`;
  listaPermisos.innerHTML+=`
   <label>
    <input type="checkbox" value="${m[4]}"> ${m[1]}
   </label>`;
 });
}

async function crearModulo(){
 await fetch(API,{
  method:"POST",
  headers:{ "Content-Type":"text/plain" },
  body:JSON.stringify({
    action:"crearModulo",
    nombre:m_nombre.value,
    archivo:m_archivo.value,
    icono:m_icono.value,
    permiso:m_permiso.value,
    activo:m_activo.value
  })
 });
 cargarModulos();
}

/* ========== USUARIO MODAL ========== */
function abrirCrearUsuario(){
 modalUsuario.style.display="flex";
}

function cerrarUsuario(){
 modalUsuario.style.display="none";
}
</script>

</body>
</html>
